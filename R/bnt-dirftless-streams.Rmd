---
title: "Driftless trout streams"
author: "Bryan Maitland"
date: "7 July 2021"
output: github_document
---

```{r prep, warning=FALSE, message=FALSE}
library(tidyverse)
library(here)
library(wdnr.fmdb)
set_fmdb_credentials()
library(rgdal)  
library(sf)
library(glue)
```


## Data

### stream lines and ecoregion polygons

```{r read-lines-polys, cache=TRUE, warning=FALSE}

# load classified trout stream lines
lines_classed <- 
  here("data", "classified_trout_streams","Classified_Trout_Stream_Lines.shp") %>% 
  st_read() %>% 
  st_transform(crs = 3071) 

# load driftless ecoregion polygon
poly_driftless <- 
  here("data", "ecoregions","wi_eco_l3.shp") %>% 
  st_read() %>% 
  st_transform(crs = 3071) %>% 
  filter(US_L3CODE == "52")

# load full 24K flowline layer
# strms_whd <- 
#   readOGR(
#     dsn = here("data", "24K_Hydro.gdb"), 
#     layer = "WD_HYDRO_FLOWLINE_LN_24K") %>% 
#   st_as_sf() %>% 
#   mutate(hydroid = as.character(HYDROID))

```

### FMDB surveys and efforts

Download all surveys from 1994-2020 on streams using backpack and stream shockers:

```{r pull-save-raw-surveys-efforts-data, cache=TRUE}

# start <- Sys.time()
# 
# # params for pulling surveys and efforts
# yrs <- list(1994:1999,2000:2005,2006:2011,2012:2016,2017:2020)  
# waterbody_types <- c( "wadable_stream", "non-wadable_stream", "stream")
# gear_types <- c("stream_shocker","backpack_shocker")
# 
# # set loop output
# full.s <- list()
# full.e <- list()
# 
# # run loop
# for (y in seq_along(yrs)) {
#   
#   surveys <- get_fmdb_surveys(year = yrs[[y]], 
#                               waterbody_type = waterbody_types) 
#   
#   efforts <- get_fmdb_efforts(year = yrs[[y]], 
#                         waterbody_type = waterbody_types,
#                         gear = gear_types)
#   full.s[[y]] <- surveys
#   full.e[[y]] <- efforts
#   
# }
# 
# # bind data together
# df_surveys_raw <- bind_rows(full.s)
# df_efforts_raw <- bind_rows(full.e) 
# 
# 
# Sys.time() - start  # ~ 48 seconds
# 
# # clean up 
# rm(full.e); rm(full.s); rm(yrs); rm(y); rm(start)
# rm(efforts); rm(surveys)
# 
# write_rds(df_surveys_raw, here("data", "surveys_raw_20210707.rds"))
# write_rds(df_efforts_raw, here("data", "efforts_raw_20210707.rds"))

```

```{r read-raw-survery-efforts-data}
df_surveys_raw <- read_rds(here("data", "surveys_raw_20210707.rds"))
df_efforts_raw <- read_rds(here("data", "efforts_raw_20210707.rds"))
```

### filter surveys/efforts for proofed data

```{r filter-proofed-data, eval=TRUE}

# list of good surveys status
targ.survs <- c(
  "data_entry_complete_and_proofed",
  "historical_data_complete_and_proofed",
  "historical_data_entry_complete",
  "historical_data_load_status_unknown"
  )

# filter surveys by unique efforts and status
df_surveys <-
  df_surveys_raw %>% 
  filter(survey.seq.no %in% unique(df_efforts_raw$survey.seq.no)) %>% 
  filter(survey.status %in% targ.survs)

# filter effort
df_efforts <- 
  df_efforts_raw %>% 
  filter(survey.seq.no %in% df_surveys$survey.seq.no) %>%
  filter(site.seq.no != 315)

df_surveys <- 
  df_surveys %>% 
  filter(survey.seq.no %in% unique(df_efforts$survey.seq.no))

rm(df_surveys_raw); rm(df_efforts_raw)

```

### clip data to driftless

```{r clip-data-to-driftless, cache=TRUE}

# clip the classified trout streams to driftless region
lines_classed_drift <- 
  lines_classed %>% 
  st_intersection(poly_driftless)

# clip surveys to driftless to pull fish data
df_surveys_drift <- 
  df_surveys %>% 
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326) %>% 
  st_transform(crs = 3071) %>% 
  st_intersection(poly_driftless)

# filter efforts to driftless region based on filtered surveys
df_efforts_drift <- 
  df_efforts %>% 
  filter(survey.seq.no %in% df_surveys_drift$survey.seq.no)

# isolate unique survey site locations in driftless
df_surveys_drift_locs <- 
  df_surveys_drift %>% 
  distinct(site.seq.no, .keep_all = TRUE) %>% 
  select(wbic, site.seq.no) 


# clip 24k flowlines to the driftless region
# hydro_lines_driftless <- 
#   hydro_lines %>% 
#   st_intersection(driftless_poly)
```

### count of surveys in driftless from 1994-2020:

```{r count-survs-in-drift}
n.surveys <- 
  df_surveys_drift %>% 
  distinct(survey.seq.no) %>% 
  pull() %>% 
  length() %>% 
  print()
```

### count of distinct wbics in all driftless survey data:

```{r count-wbics-in-drift-survs}
n.wbics.surveyed <- 
  df_surveys_drift %>% 
  distinct(wbic) %>% 
  pull() %>% 
  length() %>% 
  print()
```

### count of distinct wbics in classified stream flowlines:

```{r count-wbics-in-class-streams}
n.wbics.classified <- 
  lines_classed_drift %>% 
  distinct(WBIC) %>% 
  pull() %>% 
  length() %>% 
  print()
```

### count of distinct wbics in classified streams also surveys:

```{r nn-spatial-join-sites-to-lines, cache=TRUE}
df_surveys_drift_classed <- 
  df_surveys_drift_locs %>% 
  st_join(lines_classed_drift, join = nngeo::st_nn, k = 1, maxdist = 100)
```

```{r count-wbics-in-classed-surved, cache=TRUE}
n.wbics.classed.surveyed <- 
  df_surveys_drift_classed %>% 
  filter(!is.na(TROUT_CLAS)) %>% 
  st_drop_geometry() %>% 
  distinct(wbic) %>% 
  pull() %>% 
  length() %>% 
  print()
```

```{r count-wbics-in-classed12-surved, cache=TRUE}
n.wbics.classed12.surveyed <- 
  df_surveys_drift_classed %>% 
  filter(TROUT_CLAS %in% c("CLASS I", "CLASS II") ) %>% 
  st_drop_geometry() %>% 
  distinct(wbic) %>% 
  pull() %>% 
  length() %>% 
  print()
```

### plot driftless surveys and classed streams

```{r plot data}
ggplot() + 
  geom_sf(data = poly_driftless) + 
  geom_sf(data = lines_classed_drift, aes(color = TROUT_CLAS), show.legend = "line") + 
  geom_sf(data = df_surveys_drift_classed, aes(fill = TROUT_CLAS), show.legend = "point", 
          size = 1, alpha = 0.5, shape = 21) + 
  scale_colour_manual(values = c("#53DC4D", "#00C5ff", "#004DA8"), 
                      guide = guide_legend(
                        override.aes = list(
                          linetype = c("solid", "solid","solid"), 
                          shape = c(NA, NA, NA),
                          size = c(1,1,1)))
                      ) +
  scale_fill_manual(values = c("#53DC4D", "#00C5ff", "#004DA8", "grey"), 
                    guide = guide_legend(
                      override.aes = list(linetype = "blank", 
                                          shape = 21, 
                                          size = 2))
                    ) +
  labs(
    title = "Driftless Area survey locations", color = "Stream Class", fill = "Survey Site Class"
    ) +
  theme_void()
```


### downlaod fishraw data

```{r pull-raw-fish, cache=TRUE}
# start <- Sys.time()
# 
# # using efforts, download fish data 1000 efforts at a time
# vs <- unique(df_efforts_drift$visit.fish.seq.no) 
# 
# # split efforts in 1000 chunks
# chunks <- split(vs, ceiling(seq_along(vs)/1000))  
# 
# # set loop output
# full.dat <- list()
# 
# for (i in (1:length(chunks))) {  
#   d <- get_fmdb_fishraw(visit_seq = chunks[[i]])
#   full.dat[[i]] <- d
# }
# 
# df_fish_raw <- bind_rows(full.dat)
# 
# # Check deleted rows and warnings
# length_deleted_rows 
# length_warning_rows  # 
# 
# Sys.time() - start  # ~ 3 min minutes
# 
# # clean up environment
# rm(vs); rm(chunks); rm(full.dat); rm(d); rm(i); rm(start)
# rm(length_deleted_rows)
# rm(length_warning_rows)
# 
# write_rds(df_fish_raw, here("data", "fish_raw_20210727.rds"))
```

```{r load-raw-fish-data}
df_fish_raw <- 
  here("data", "fish_raw_20210727.rds") %>% 
  read_rds()
```


## counts

### count of surveyed streams in which brown trout are present

```{r, message=FALSE}
# convert catch data to presence/abscence
df_bnt_pa <-
  df_fish_raw %>% 
  filter(species == "brown_trout") %>% 
  group_by(wbic, site.seq.no) %>% 
  summarise(n = sum((number.of.fish)), .groups = "drop") %>% 
  mutate(n = if_else(n == 0, 0, 1)) %>% 
  # join survey metadata for coords
  left_join(df_surveys_drift_locs %>% select(-wbic), by = "site.seq.no") 

df_bnt_pa %>% 
  count(n)

# count of streams in which brown trout were present
n.wbics.bnt.p <- 
  df_bnt_pa %>% 
  filter(n == 1) %>% 
  select(-geometry) %>% 
  distinct(wbic) %>% 
  pull() %>% 
  length()
```


## 1. Percentage of survyed streams in which brown trout are present

```{r}
(percent.wbics.bnt.present <- round((n.wbics.bnt.p/n.wbics.surveyed) * 100, digits = 2))
```

## 2. Percentage of survyed streams in which brown trout are present

```{r}
(percent.wbics.bnt.present <- round((n.wbics.bnt.p/n.wbics.classified) * 100, digits = 2))
```

## 3. Percentage of survyed streams in which brown trout are present

```{r}
(percent.wbics.bnt.present <- round((n.wbics.bnt.p/n.wbics.classed.surveyed) * 100, digits = 2))
```

## 4. Percentage of survyed streams in which brown trout are present

```{r}
(percent.wbics.bnt.present <- round((n.wbics.bnt.p/n.wbics.classed12.surveyed) * 100, digits = 2))
```


```{r plot data}
ggplot() + 
  geom_sf(data = poly_driftless) + 
  geom_sf(data = lines_classed_drift, aes(color = TROUT_CLAS)) +
  geom_sf(data = df_bnt_pa %>% st_as_sf(), 
          aes(fill = as.factor(n)), 
          shape = 21, size = 1, alpha = 0.5) + 
  scale_fill_manual(values = c("black", "white")) + 
  labs(
    title = "How common are Brown Trout in Wisconsin's Driftless Area?",
    color = "Stream Class", 
    fill = "BNT Presence") + 
  theme_void()

path <- here::here("driftless_bnt_presence")
ggsave(glue::glue("{path}.pdf"), width = 6.5, height = 6, device = cairo_pdf)
pdftools::pdf_convert(pdf = glue::glue("{path}.pdf"),
            filenames = glue::glue("{path}.png"),
            format = "png", dpi = 300)
  
```




