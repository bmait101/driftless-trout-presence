---
title: "Driftless BNT streams"
author: "Bryan Maitland"
date: "7 July 2021"
output: github_document
---

## Overview

What is the percentage of Driftless ecoregion streams (by WBIC for streams for which we have survey data) in which brown trout are present?

```{r prep, warning=FALSE, message=FALSE}
library(tidyverse)
library(here)
library(rgdal)  
library(sf)
```


## Data

**NOTE:** WI 24k Hydrogrodatabase data is available from [this link](https://data-wi-dnr.opendata.arcgis.com/datasets/wi-dnr::24k-hydro-flowlines-rivers-streams/about). 

```{r read-data, cache=TRUE, warning=FALSE}

trout_data <- 
  here("fmdb_fish_trout.rds") %>% 
  read_rds()

trout_surveys <- 
  here("fmdb_surveys_trout.rds") %>% 
  read_rds() %>% 
  distinct(site.seq.no, .keep_all = TRUE) %>% 
  select(site.seq.no, latitude, longitude) 

trout_sites_VA <- 
  here("trout-sites-24K-VA.rds") %>% 
  read_rds()

hydro_lines_classed <- 
  here("classified_trout_streams","Classified_Trout_Stream_Lines.shp") %>% 
  st_read() %>% 
  st_transform(crs = 3071) 

driftless_poly <- 
  here("ecoregions","wi_eco_l3.shp") %>% 
  st_read() %>% 
  st_transform(crs = 3071) %>% 
  filter(US_L3CODE == "52")

hydro_lines <- 
  readOGR(
    dsn = here("24K_Hydro.gdb"), 
    layer = "WD_HYDRO_FLOWLINE_LN_24K") %>% 
  st_as_sf() %>% 
  mutate(hydroid = as.character(HYDROID))

```


```{r prep-data, cache=TRUE}

hydro_lines_driftless <- 
  hydro_lines %>% 
  st_intersection(driftless_poly)

hydro_lines_classed_drift <- 
  hydro_lines_classed %>% 
  st_intersection(driftless_poly)

data <- 
  trout_data %>% 
  left_join(trout_sites_VA, by = "site.seq.no") %>% 
  select(county, waterbody.name, wbic, survey.year, survey.seq.no, visit.fish.seq.no, site.seq.no,
         species, number.of.fish, c_eco, hydroid) %>% 
  filter(c_eco == "52") %>% 
  filter(species == "brown_trout")

```

```{r plot data}

ggplot() + 
  geom_sf(data = driftless_poly) + 
  geom_sf(data = hydro_lines_classed_drift, aes(color = TROUT_CLAS))

```


### get number of wbics

```{r}
# number of distinct wbics in classified streams
num.of.wbics.24k <- 
  hydro_lines_classed_drift %>% 
  distinct(WBIC) %>% 
  pull() %>% 
  length()
```

```{r}
# number of distinct surveys wbics
num.of.wbics <- 
  data %>% 
  distinct(wbic) %>% 
  pull() %>% 
  length()
```

### get number of wbics with BNT

```{r, message=FALSE}
bnt_pa <-
  data %>% 
  group_by(wbic, site.seq.no) %>% 
  summarise(n = sum((number.of.fish))) %>% 
  mutate(n = if_else(n == 0, 0, 1)) %>% 
  left_join(trout_surveys, by = "site.seq.no") %>% 
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326) %>% 
  st_transform(crs = 3071)


num.of.bnt.wbics <- 
  bnt_pa %>% 
  filter(n == 1) %>% 
  distinct(wbic) %>% 
  pull() %>% 
  length()
```


### calculate % streams with BNT

```{r, message=FALSE}
(percent.wbics.w.bnt <- round((num.of.bnt.wbics/num.of.wbics) * 100, digits = 2))

(percent.wbics24k.w.bnt <- round((num.of.bnt.wbics/num.of.wbics.24k) * 100, digits = 2) )

```

## Results

In the Driftless Ecoregion of Wisconsin, `r percent.wbics.w.bnt`% of surveyed wbics have Brown Trout present, while `r percent.wbics24k.w.bnt`% of *all* wbics classified as trout streans have Brown Trout present.  

**NOTE:** Result is based on survey data collected from 1994-2020 by Fisheries Management. 

```{r plot data}
ggplot() + 
  geom_sf(data = driftless_poly) + 
  geom_sf(data = hydro_lines_classed_drift, aes(color = TROUT_CLAS)) +
  geom_sf(data = bnt_pa, aes(fill = as.factor(n)), shape = 21, size = 1, alpha = 0.5) + 
  scale_fill_manual(values = c("black", "white")) + 
  labs(
    title = "How common are Brown Trout in Wisconsin's Driftless Area?",
    subtitle = glue::glue('Brown Trout are present in {percent.wbics.w.bnt}% of surveyed WBICs in the area, \n in {percent.wbics24k.w.bnt}% of WBICs which are classified trout streams.'),
    color = "Stream Class", fill = "BNT Presence") + 
  theme_void()

path <- here::here("driftless_bnt_presence")
ggsave(glue::glue("{path}.pdf"), width = 6.5, height = 6, device = cairo_pdf)
pdftools::pdf_convert(pdf = glue::glue("{path}.pdf"),
            filenames = glue::glue("{path}.png"),
            format = "png", dpi = 300)
  
```
