---
title: "How common are trout in Driftless streams"
author: "Bryan Maitland"
date: "29 July 2021"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

## Overview

What is the percentage of Driftless area streams in which Brook, Brown, or Tiger Trout are present?

```{r prep, echo=FALSE}
library(tidyverse)
library(here)
library(wdnr.fmdb)
# set_fmdb_credentials()
library(rgdal)  
library(sf)
library(glue)
```


## 1. Data

### FMDB surveys and efforts

Download all surveys from 1994-2020 on streams using backpack and stream shockers, retaining only surveys that are complete and proofed:

```{r pull-save-raw-surveys-efforts-data, echo=FALSE}

# start <- Sys.time()
# 
# # params for pulling surveys and efforts
# yrs <- list(1994:1999,2000:2005,2006:2011,2012:2016,2017:2020)  
# waterbody_types <- c( "wadable_stream", "non-wadable_stream", "stream")
# gear_types <- c("stream_shocker","backpack_shocker")
# 
# # set loop output
# full.s <- list()
# full.e <- list()
# 
# # run loop
# for (y in seq_along(yrs)) {
#   
#   surveys <- get_fmdb_surveys(year = yrs[[y]], 
#                               waterbody_type = waterbody_types) 
#   
#   efforts <- get_fmdb_efforts(year = yrs[[y]], 
#                         waterbody_type = waterbody_types,
#                         gear = gear_types)
#   full.s[[y]] <- surveys
#   full.e[[y]] <- efforts
#   
# }
# 
# # bind data together
# df_surveys_raw <- bind_rows(full.s)
# df_efforts_raw <- bind_rows(full.e) 
# 
# 
# Sys.time() - start  # ~ 48 seconds
# 
# # clean up 
# rm(full.e); rm(full.s); rm(yrs); rm(y); rm(start)
# rm(efforts); rm(surveys)
# 
# write_rds(df_surveys_raw, here("data", "surveys_raw_20210707.rds"))
# write_rds(df_efforts_raw, here("data", "efforts_raw_20210707.rds"))

```

```{r read-raw-survery-efforts-data}
# data pulled from FMDB in hidden step
df_surveys_raw <- read_rds(here("data", "surveys_raw_20210707.rds"))
df_efforts_raw <- read_rds(here("data", "efforts_raw_20210707.rds"))
```

```{r filter-proofed-data, eval=TRUE, echo=FALSE}

# list of good surveys status
targ.survs <- c(
  "data_entry_complete_and_proofed",
  "historical_data_complete_and_proofed",
  "historical_data_entry_complete",
  "historical_data_load_status_unknown"
  )

# filter surveys by unique efforts and status
df_surveys <- 
  df_surveys_raw %>% 
  filter(survey.seq.no %in% unique(df_efforts_raw$survey.seq.no)) %>% 
  filter(survey.status %in% targ.survs)

# filter effort on filtered surveys and remove 315 sites
df_efforts <- 
  df_efforts_raw %>% 
  filter(survey.seq.no %in% df_surveys$survey.seq.no) %>%
  filter(site.seq.no != 315)

# clean up
rm(df_surveys_raw); rm(df_efforts_raw)
```


### clip survey data to driftless region:

```{r load-lines-polys, cache=TRUE, results = 'hide', echo=FALSE}
poly_driftless <- 
  here("data", "ecoregions","wi_eco_l3.shp") %>% 
  st_read() %>% 
  st_transform(crs = 3071) %>% 
  filter(US_L3CODE == "52")

lines_classed <- 
  here("data", "classified_trout_streams","Classified_Trout_Stream_Lines.shp") %>% 
  st_read() %>% 
  st_transform(crs = 3071) 

# clip the classified trout streams to driftless region
lines_classed_drift <- 
  lines_classed %>% 
  st_intersection(poly_driftless)

```

```{r clip-data-to-driftless, cache=TRUE}

# first clip surveys to driftless area
df_surveys_drift <- 
  df_surveys %>% 
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326) %>% 
  st_transform(crs = 3071) %>% 
  st_intersection(poly_driftless)

# then filter efforts to clipped surveys
df_efforts_drift <- 
  df_efforts %>% 
  filter(survey.seq.no %in% df_surveys_drift$survey.seq.no)

# isolate unique survey site locations in driftless
df_surveys_drift_locs <- 
  df_surveys_drift %>% 
  distinct(site.seq.no, .keep_all = TRUE) %>% 
  select(wbic, site.seq.no) 
```

### download fishraw data for driftless region surveys:

```{r pull-raw-fish, echo=FALSE}
# start <- Sys.time()
# 
# # using efforts, download fish data 1000 efforts at a time
# vs <- unique(df_efforts_drift$visit.fish.seq.no) 
# 
# # split efforts in 1000 chunks
# chunks <- split(vs, ceiling(seq_along(vs)/1000))  
# 
# # set loop output
# full.dat <- list()
# 
# for (i in (1:length(chunks))) {  
#   d <- get_fmdb_fishraw(visit_seq = chunks[[i]])
#   full.dat[[i]] <- d
# }
# 
# df_fish_raw <- bind_rows(full.dat)
# 
# # Check deleted rows and warnings
# length_deleted_rows 
# length_warning_rows  # 
# 
# Sys.time() - start  # ~ 3 min minutes
# 
# # clean up environment
# rm(vs); rm(chunks); rm(full.dat); rm(d); rm(i); rm(start)
# rm(length_deleted_rows)
# rm(length_warning_rows)
# 
# write_rds(df_fish_raw, here("data", "fish_raw_20210727.rds"))
```

```{r load-raw-fish-data}
# data pulled from FMDB in hidden step
df_fish_raw <- 
  here("data", "fish_raw_20210727.rds") %>% 
  read_rds() 
```

## 2. Count of surveys and streams (wbics)

#### number of distinct surveys in driftless from 1994-2020:

```{r echo=FALSE}
n.surveys <- 
  df_surveys_drift %>% 
  distinct(survey.seq.no) %>% 
  pull() %>% 
  length() %>% 
  print()
```

#### number of distinct wbics in driftless suvrvey data:

```{r echo=FALSE}
n.wbics.surveyed <- 
  df_surveys_drift %>% 
  distinct(wbic) %>% 
  pull() %>% 
  length() %>% 
  print()
```

#### number of distinct wbics in classified trout streams layer:

```{r echo=FALSE}
n.wbics.classified <- 
  lines_classed_drift %>% 
  distinct(WBIC) %>% 
  pull() %>% 
  length() %>% 
  print()
```

and by class:

```{r echo=FALSE}
lines_classed_drift %>% 
  st_drop_geometry() %>% 
  count(TROUT_CLAS)
```


#### number of surveyed wbics in the driftless also on classified streams:

To do this, we need to join sites to nearest classified stream to get a site's stream class (so sites that are not on or near a classified stream get an NA for stream class.
```{r nn-spatial-join-sites-to-lines, cache=TRUE, echo=FALSE}
# df_surveys_drift_classed <-
#   df_surveys_drift_locs %>%
#   st_join(lines_classed_drift, join = nngeo::st_nn, k = 1, maxdist = 100)
# write_rds(df_surveys_drift_classed, here("data", "df_surveys_drift_classed.rds"))

df_surveys_drift_locs_classes <- 
  here("data", "df_surveys_drift_classed.rds") %>% 
  read_rds() %>% 
  select(site.seq.no, TROUT_CLAS)

df_surveys_drift_classed <- 
  df_surveys_drift %>% 
  left_join(df_surveys_drift_locs_classes %>% st_drop_geometry(), by = "site.seq.no")

```

##### number of surveyed wbics in the driftless also on classified streams:
```{r echo=FALSE}
n.wbics.classed.surveyed <- 
  df_surveys_drift_classed %>% 
  filter(!is.na(TROUT_CLAS)) %>% 
  st_drop_geometry() %>% 
  distinct(wbic) %>% 
  pull() %>% 
  length() %>% 
  print()
```

##### number of surveyed wbics in the driftless also on classified streams I/II:
```{r count-wbics-in-classed12-surved, echo=FALSE}
n.wbics.classed12.surveyed <- 
  df_surveys_drift_classed %>% 
  st_drop_geometry() %>% 
  filter(TROUT_CLAS %in% c("CLASS I", "CLASS II") ) %>% 
  distinct(wbic) %>% 
  pull() %>% 
  length() %>% 
  print()
```

### plot of driftless survey sites and classified streams:

```{r echo=FALSE, fig.align='center'}
ggplot() + 
  geom_sf(data = poly_driftless) + 
  geom_sf(data = lines_classed_drift, aes(color = TROUT_CLAS), show.legend = "line") + 
  geom_sf(data = df_surveys_drift_classed, aes(fill = TROUT_CLAS), show.legend = "point", 
          size = 1, alpha = 0.5, shape = 21) + 
  scale_colour_manual(
    values = c("#53DC4D", "#00C5ff", "#004DA8"), 
    guide = guide_legend(
      override.aes = list(linetype = c("solid", "solid","solid"), 
                          shape = c(NA, NA, NA),
                          size = c(1,1,1)))
    ) +
  scale_fill_manual(
    values = c("#53DC4D", "#00C5ff", "#004DA8", "grey"), 
    guide = guide_legend(
      override.aes = list(linetype = "blank",
                          shape = 21, 
                          size = 2))
    ) +
  labs(
    # title = "Driftless Area survey locations", 
    color = "Stream Class", 
    fill = "Survey Site Class"
    ) +
  theme_void() + 
  theme(plot.title = element_text(hjust = 0.5))
```


## 3. Trout presence/abscence

#### isolate and plot zero captures

```{r zero-caps, message=FALSE, echo=FALSE}
# isolate zero captures
df_no_fish <- 
  df_fish_raw %>% 
  filter(species == "no_fish_captured") 
```

```{r tables-targs, echo=FALSE, include=FALSE}
# target species
df_no_fish %>% 
    group_by(target.species) %>% 
    tally() %>% 
    arrange(desc(n)) %>% 
    mutate(
      target.species = 
        stringr::str_replace_all(target.species, "_", " ")
      ) %>% 
    select('Target species' = target.species, Count = n) 

# survey purpose
df_no_fish %>% 
    group_by(primary.survey.purpose) %>% 
    tally() %>% 
    arrange(desc(n)) %>% 
    mutate(
      primary.survey.purpose = 
        stringr::str_replace_all(primary.survey.purpose, "_", " ")
      ) %>% 
    select('Primary Survey Purpose' = primary.survey.purpose, Count = n) 
```

```{r map-zero-caps, fig.align='center', echo=FALSE}
df_no_fish %>% 
  left_join(df_surveys_drift_locs, by = "site.seq.no") %>% 
  st_as_sf() %>% 
  ggplot() + 
  geom_sf(
    data = poly_driftless, 
    color = "black", alpha = 0) + 
  geom_sf(
    aes(fill = target.species), 
    shape = 21, size = 2, color = "black", alpha = 0.75)  +
  scale_fill_viridis_d(option = "D") + 
  labs(x = "", y = "", 
       fill = "Target species") +  
  theme_void() +
  theme(plot.title = element_text(hjust = 0.5))
```

#### convert to species-specific zeros and subset trout data:

```{r df-of-zeros, echo=FALSE}

df_trout_0s <-
  bind_rows(
    # all species and game fish targets
    df_fish_raw %>%
      filter(target.species %in% c("all_species","gamefish_species"), 
             species == "no_fish_captured") %>%
      mutate(
        species = "brook_trout",
        number.of.fish = 0,
        ),
    df_fish_raw %>%
      filter(target.species %in% c("all_species","gamefish_species"), 
             species == "no_fish_captured") %>%
      mutate(
        species = "brown_trout",
        number.of.fish = 0, 
        ),
    # brook trout targets
    df_fish_raw %>%
      filter(target.species %in% c("brook_trout"), 
             species == "no_fish_captured") %>%
      mutate(
        species = "brook_trout",
        number.of.fish = 0, 
        ),
    # brown trout targets
    df_fish_raw %>%
      filter(target.species %in% c("brown_trout"), 
             species == "no_fish_captured") %>%
      mutate(
        species = "brown_trout",
        number.of.fish = 0, 
        )
  )

```

```{r remove-no-caps-add-zeros}
df_fish <- 
  df_fish_raw %>% 
  filter(!species == "no_fish_captured") %>%
  bind_rows(df_trout_0s) %>%  # this df is made in a hidden step previous to this
  mutate(species = if_else(species == "tiger_trout_(i21_x_i22)", "tiger_trout", species)) %>% 
  filter(species %in% c("brook_trout","brown_trout","tiger_trout"))
```

### count of surveyed wbics in which trout are present:

#### convert catch data to presence data:
```{r}
# convert catch data to presence
df_fish_presence <-
  df_fish %>% 
  group_by(wbic, survey.seq.no, species) %>% 
  summarise(n = sum((number.of.fish)), .groups = "drop") %>% 
  mutate(n = if_else(n > 1, 1, 0)) %>% 
  # join survey metadata for coords/classes
  left_join(df_surveys_drift_classed %>% 
              select(survey.seq.no, TROUT_CLAS), by = "survey.seq.no")

```

#### check counts of surveys where trout are presencet and absent:
```{r echo=FALSE}
# check species counts
df_fish_presence %>% 
  count(species, n)
```


#### count of surveyed wbics in which trout are present

```{r echo=FALSE}
# count of streams in which brown trout were present
n.wbics.bnt.p <- 
  df_fish_presence %>% 
  filter(species == "brown_trout", n == 1) %>% 
  # select(-geometry) %>% 
  distinct(wbic) %>% 
  pull() %>% 
  length()

# count of 1-2 class streams in which brown trout were present
n.wbics.bnt.p.12 <- 
  df_fish_presence %>% 
  filter(TROUT_CLAS %in% c("CLASS I", "CLASS II") ) %>% 
  filter(species == "brown_trout", n == 1) %>% 
  select(-geometry) %>% 
  distinct(wbic) %>% 
  pull() %>% 
  length()

# count of streams in which brown trout were present
n.wbics.bkt.p <- 
  df_fish_presence %>% 
  filter(species == "brook_trout", n == 1) %>% 
  select(-geometry) %>% 
  distinct(wbic) %>% 
  pull() %>% 
  length()

# count of 1-2 class streams in which brown trout were present
n.wbics.bkt.p.12 <- 
  df_fish_presence %>% 
  filter(TROUT_CLAS %in% c("CLASS I", "CLASS II") ) %>% 
  filter(species == "brook_trout", n == 1) %>% 
  select(-geometry) %>% 
  distinct(wbic) %>% 
  pull() %>% 
  length()

# count of streams in which brown trout were present
n.wbics.tiger.p <- 
  df_fish_presence %>% 
  filter(species == "tiger_trout", n == 1) %>% 
  select(-geometry) %>% 
  distinct(wbic) %>% 
  pull() %>% 
  length()

# count of 1-2 class streams in which brown trout were present
n.wbics.tiger.p.12 <- 
  df_fish_presence %>% 
  filter(TROUT_CLAS %in% c("CLASS I", "CLASS II") ) %>% 
  filter(species == "tiger_trout", n == 1) %>% 
  select(-geometry) %>% 
  distinct(wbic) %>% 
  pull() %>% 
  length()


# sympatry
n.wbics.bnt.p <- 
  df_fish_presence %>% 
  select(-geometry, -TROUT_CLAS) %>% 
  filter(species %in% c("brown_trout","brook_trout")) %>%
  pivot_wider(id_cols = 1:3, names_from = species, values_from = n)
  distinct(wbic) %>% 
  pull() %>% 
  length()
```

```{r}
# brown
n.wbics.bnt.p
# n.wbics.bnt.p.12

# brook
n.wbics.bkt.p
# n.wbics.bkt.p.12

# tiger
n.wbics.tiger.p
# n.wbics.tiger.p.12
```

## 4. calculate percentages

#### brown trout 
```{r}
# class 1-3
(percent.wbics.bnt.present <- round((n.wbics.bnt.p/n.wbics.classed.surveyed) * 100, digits = 2))
# class 1-2
(percent.wbics.bnt.present12 <- round((n.wbics.bnt.p.12/n.wbics.classed12.surveyed) * 100, digits = 2))
```

#### brook trout
```{r}
# class 1-3
(percent.wbics.bkt.present <- round((n.wbics.bkt.p/n.wbics.classed.surveyed) * 100, digits = 2))
# class 1-2
(percent.wbics.bkt.present12 <- round((n.wbics.bkt.p.12/n.wbics.classed12.surveyed) * 100, digits = 2))
```

#### tiger trout
```{r}
# class 1-3
(percent.wbics.tgt.present <- round((n.wbics.tiger.p/n.wbics.classed.surveyed) * 100, digits = 2))
# class 1-2
(percent.wbics.tgt.present12 <- round((n.wbics.tiger.p.12/n.wbics.classed12.surveyed) * 100, digits = 2))
```

### plot presence/absence

```{r fig.align='center', echo=FALSE, fig.width=10}
panel_labels <- c(
  `brook_trout` = glue("Brook Trout ({percent.wbics.bkt.present}%)"),
  `brown_trout` = glue("Brown Trout ({percent.wbics.bnt.present}%)"),
  `tiger_trout` = glue("Tiger Trout ({percent.wbics.tgt.present}%)")
  )

ggplot() + 
  geom_sf(data = poly_driftless, fill = "white") +
  geom_sf(data = lines_classed_drift, 
          aes(color = TROUT_CLAS), show.legend = "line") +
  # geom_sf(data = df_surveys_drift_locs_classes %>% filter(is.na(TROUT_CLAS)),
  #         size = 1, shape = 16, color = "grey", alpha = 0.25) +
  geom_sf(data = df_fish_presence %>% st_as_sf(), 
          aes(fill = as.factor(n)), show.legend = "point",
          shape = 21, size = 1, alpha = 0.5) + 
  scale_colour_manual(
    values = c("#53DC4D", "#00C5ff", "#004DA8"), 
    guide = guide_legend(
      override.aes = list(linetype = c("solid", "solid","solid"), 
                          shape = c(NA, NA, NA),
                          size = c(1,1,1)))
    ) +
  scale_fill_manual(
    values = c("black", "white"), 
    labels = c("Absent", "Present"),
    guide = guide_legend(
      override.aes = list(linetype = "blank",
                          shape = 21, alpha = 1,
                          size = 2))
    ) +
  facet_wrap(vars(species), labeller = as_labeller(panel_labels)) +
  labs(
    # title = "How common are trout in Driftless Area streams?",
    title ="Percent of all classified and surveyed streams with trout present:",
    # subtitle ="Percent of all classified and surveyed streams with trout present:",
    # caption = "Note: light grey dots depict all surveys sites in the region",
    color = "Stream Class", 
    fill = "Trout Presence") + 
  theme_void() + 
  theme(
    plot.title = element_text(hjust = 0.5, family = "sans", size = 18, margin=margin(0,0,5,0)), 
    plot.subtitle = element_text(hjust = 0.5, family = "sans", size = 12, margin=margin(0,0,10,0))
    )

path <- here::here("plots", "driftless_trout_presence")
ggsave(glue::glue("{path}.pdf"), width = 10, height = 5, device = cairo_pdf)
pdftools::pdf_convert(pdf = glue::glue("{path}.pdf"),
            filenames = glue::glue("{path}.png"),
            format = "png", dpi = 300)
  
```


```{r fig.align='center', echo=FALSE, fig.width=10}
panel_labels <- c(
  `brook_trout` = glue("Brook Trout ({percent.wbics.bkt.present12}%)"),
  `brown_trout` = glue("Brown Trout ({percent.wbics.bnt.present12}%)"),
  `tiger_trout` = glue("Tiger Trout ({percent.wbics.tgt.present12}%)")
  )

ggplot() + 
  geom_sf(data = poly_driftless, fill = "white") +
  geom_sf(data = lines_classed_drift %>% 
            filter(TROUT_CLAS %in% c("CLASS I", "CLASS II")), 
          aes(color = TROUT_CLAS), show.legend = "line") +
  # geom_sf(data = df_surveys_drift_locs_classes %>% 
  #           filter(TROUT_CLAS %in% c("CLASS I", "CLASS II")),
  #         size = 1, shape = 16, color = "grey", alpha = 0.25) +
  geom_sf(data = df_fish_presence %>% 
            st_as_sf() %>% 
            filter(TROUT_CLAS %in% c("CLASS I", "CLASS II")), 
          aes(fill = as.factor(n)), show.legend = "point",
          shape = 21, size = 1, alpha = 0.5) + 
  scale_colour_manual(
    values = c("#53DC4D", "#00C5ff"), 
    guide = guide_legend(
      override.aes = list(linetype = c("solid", "solid"), 
                          shape = c(NA, NA),
                          size = c(1,1)))
    ) +
  scale_fill_manual(
    values = c("black", "white"), 
    labels = c("Absent", "Present"),
    guide = guide_legend(
      override.aes = list(linetype = "blank",
                          shape = 21, alpha = 1,
                          size = 2))
    ) +
  facet_wrap(vars(species), labeller = as_labeller(panel_labels)) +
  labs(
    # title = "How common are trout in Driftless Area streams?",
    title ="Percent of class I & II surveyed streams with trout present:",
    # subtitle ="Percent of class I & II surveyed streams with trout present:",
    # caption = "Note: light grey dots depict all surveys sites in the region",
    color = "Stream Class", 
    fill = "Trout Presence") + 
  theme_void() + 
  theme(
    plot.title = element_text(hjust = 0.5, family = "sans", size = 18, margin=margin(0,0,5,0)), 
    plot.subtitle = element_text(hjust = 0.5, family = "sans", size = 12, margin=margin(0,0,10,0))
    )

path <- here::here("plots", "driftless_trout_presence_class12")
ggsave(glue::glue("{path}.pdf"), width = 10, height = 5, device = cairo_pdf)
pdftools::pdf_convert(pdf = glue::glue("{path}.pdf"),
            filenames = glue::glue("{path}.png"),
            format = "png", dpi = 300)
  
```
