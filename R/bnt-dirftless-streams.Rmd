---
title: "How common are trout in Driftless streams"
author: "Bryan Maitland"
date: "29 July 2021"
output: github_document
---

## TO DO 

* purrr the calculations and streamline
* fix infographic plots

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

## Overview

What is the percentage of Driftless area streams in which Brook, Brown, or Tiger Trout are present?

```{r prep, echo=FALSE}
library(tidyverse)
library(here)
library(wdnr.fmdb)
set_fmdb_credentials()
library(rgdal)  
library(sf)
library(glue)
```


## 1. Data

### FMDB surveys and efforts

Download all surveys from 1994-2020 on streams using backpack and stream shockers, retaining only surveys that are complete and proofed:

```{r pull-save-raw-surveys-efforts-data, echo=FALSE}
# # params for pulling surveys and efforts
# yrs <- list(1994:1999,2000:2005,2006:2011,2012:2016,2017:2020)
# waterbody_types <- c( "wadable_stream", "non-wadable_stream", "stream")
# gear_types <- c("stream_shocker","backpack_shocker")
# 
# # pull surveys
# df_surveys_raw <- 
#   yrs %>% 
#   map_df(~get_fmdb_surveys(year = ., waterbody_type = waterbody_types))
# 
# # pulls efforts
# df_efforts_raw <- 
#   yrs %>% 
#   map_df(~get_fmdb_efforts(year = ., waterbody_type = waterbody_types, gear = gear_types))
# 
# # clean up
# rm(yrs); rm(gear_types); rm(waterbody_types)
# 
# # wrtie to file
# write_rds(df_surveys_raw, here("data", "surveys_raw_20210803.rds"))
# write_rds(df_efforts_raw, here("data", "efforts_raw_20210803.rds"))

# load
df_surveys_raw <- read_rds(here("data", "surveys_raw_20210803.rds"))
df_efforts_raw <- read_rds(here("data", "efforts_raw_20210803.rds"))
```

```{r clean-survs-effs, eval=TRUE, echo=FALSE}

# # check surveys with no match in the efforts (which are for electofishing only)
# df_surveys_raw %>% 
#   anti_join(df_efforts_raw, by = "survey.seq.no") 
# # these are IBI surveys or those with efforts that are "multiple_gear_types"

# filter for unique surveys in the efforts data
df_surveys <- semi_join(df_surveys_raw, df_efforts_raw, by = "survey.seq.no")

# filter for proofed survey data
targ.survs <- c(
  "data_entry_complete_and_proofed",
  "historical_data_complete_and_proofed",
  "historical_data_entry_complete",
  "historical_data_load_status_unknown")
df_surveys <- filter(df_surveys, survey.status %in% targ.survs)

# set target species
targ.spp <- c(
  "all_species","gamefish_species","gamefish_panfish",
  "trout_spp","brown_trout","brook_trout","rainbow_trout")

# filter
df_efforts <- 
  df_efforts_raw %>% 
  semi_join(df_surveys, by = "survey.seq.no") %>% 
  filter(target.species %in% targ.spp | secondary.target.species %in% targ.spp) %>% 
  filter(site.seq.no != 315) 

# surveys again by the cleaned efforts
df_surveys <- semi_join(df_surveys, df_efforts, by = "survey.seq.no")

# clean up 
rm(df_surveys_raw);rm(df_efforts_raw)
rm(targ.survs); rm(targ.spp)
```


### clip survey data to driftless region:

```{r load-lines-polys, cache=TRUE, results = 'hide', echo=FALSE}
# load driftless polygon
driftless <- 
  here("data", "ecoregions","wi_eco_l3.shp") %>% 
  st_read() %>% 
  st_transform(crs = 3071) %>% 
  filter(US_L3CODE == "52")

# load classified trout stream lines
lines <- 
  here("data", "classified_trout_streams","Classified_Trout_Stream_Lines.shp") %>% 
  st_read() %>% 
  st_transform(crs = 3071) 
```

```{r clip-data-to-driftless, cache=TRUE}
# clip the classified trout streams to driftless region
lines_drift <- 
  lines %>% 
  st_intersection(driftless)

# make surveys spatial and clip to driftless area
df_surveys_drift <- 
  df_surveys %>% 
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326) %>% 
  st_transform(crs = 3071) %>% 
  st_intersection(driftless)
```

### join surevys sites to stream lines

We only want surveys on classified trout streams, so we need to link survey sites to streams to see if they are on classified water or not:
```{r nn-spatial-join-sites-to-lines, cache=TRUE, echo=FALSE}
# isolate unique survey site locations in driftless
df_surveys_drift_sites <- 
  df_surveys_drift %>% 
  distinct(site.seq.no, .keep_all = TRUE)

# # join each site to its nearest line neighbor within 50 m
# df_surveys_drift_sites_lines <-
#   st_join(df_surveys_drift_sites, lines, join = nngeo::st_nn, k = 1, maxdist = 50)
# 
# # save to file
# write_rds(df_surveys_drift_sites_lines, here("data", "df_surveys_drift_sites_lines.rds"))

# load from file
df_surveys_drift_sites_lines <-
  here("data", "df_surveys_drift_sites_lines.rds") %>%
  read_rds() %>%
  st_drop_geometry() %>% 
  select(site.seq.no, TROUT_CLAS)

# check classes
df_surveys_drift_sites_lines %>% count(TROUT_CLAS)

# add site classes to the survey data and remove NAs (unclassifed streams)
df_surveys_drift_class <- 
  left_join(df_surveys_drift, df_surveys_drift_sites_lines, by = "site.seq.no") %>% 
  as_tibble() %>% 
  filter(!is.na(TROUT_CLAS)) 
```

### filter efforts for surveys on classified streams

```{r}
# filter efforts for driftless surveys on classified streams
df_efforts_drift_class <- semi_join(df_efforts, df_surveys_drift_class, by = "survey.seq.no")
  
# clean up 
rm(df_surveys); rm(df_efforts); rm(df_surveys_drift_sites_lines)
```


### download fishraw data for driftless region surveys:

```{r pull-raw-fish, echo=FALSE}
# set chunks of visits seqs for pulling fish data
vs <- unique(df_efforts_drift_class$visit.fish.seq.no) 
vs_chunks <- split(vs, ceiling(seq_along(vs)/1000))  

df_fish_drift <- 
  vs_chunks %>% 
  map_df(~get_fmdb_fishraw(visit_seq = .))

# clean up
rm(vs); rm(vs_chunks); 
rm(length_deleted_rows); rm(length_warning_rows)

# write to file
write_rds(df_fish_drift, here("data", "fish_raw_20210803.rds"))

# load
df_fish_drift <- read_rds(here("data", "fish_raw_20210803.rds"))
```


## 2. Count of surveys and streams (wbics)

#### how many surveys and surevyed wbics?

```{r}
# print unique surveys and wbics in driftles surveys data
df_surveys_drift %>% 
  st_drop_geometry() %>% 
  summarise(across(c(survey.seq.no, wbic), ~ length(unique(.x))))

n.surveys <- length(unique(df_surveys_drift$survey.seq.no))
n.surveys.wbics <- length(unique(df_surveys_drift$wbic))
```

#### how many wbics in classified stream layer?

```{r echo=FALSE}
(n.classed.wbics <- length(unique(lines_drift$WBIC)))
```

```{r echo=FALSE}
df_surveys_drift %>% 
  st_drop_geometry() %>% 
  summarise(across(c(survey.seq.no, wbic), ~ length(unique(.x))))

n.surveys <- length(unique(df_surveys_drift$survey.seq.no))

n.wbics.classed.surveyed <- 
  df_surveys_drift %>% 
  filter(!is.na(TROUT_CLAS)) %>% 
  st_drop_geometry() %>% 
  distinct(wbic) %>% 
  pull() %>% 
  length() %>% 
  print()
```

##### number of surveyed wbics in the driftless also on classified streams I/II:
```{r count-wbics-in-classed12-surved, echo=FALSE}
n.wbics.classed12.surveyed <- 
  df_surveys_drift_classed %>% 
  st_drop_geometry() %>% 
  filter(TROUT_CLAS %in% c("CLASS I", "CLASS II") ) %>% 
  distinct(wbic) %>% 
  pull() %>% 
  length() %>% 
  print()
```

### plot of driftless survey sites and classified streams:

```{r echo=FALSE, fig.align='center'}
ggplot() + 
  geom_sf(data = poly_driftless) + 
  geom_sf(data = lines_classed_drift, aes(color = TROUT_CLAS), show.legend = "line") + 
  geom_sf(data = df_surveys_drift_classed, aes(fill = TROUT_CLAS), show.legend = "point", 
          size = 1, alpha = 0.5, shape = 21) + 
  scale_colour_manual(
    values = c("#53DC4D", "#00C5ff", "#004DA8"), 
    guide = guide_legend(
      override.aes = list(linetype = c("solid", "solid","solid"), 
                          shape = c(NA, NA, NA),
                          size = c(1,1,1)))
    ) +
  scale_fill_manual(
    values = c("#53DC4D", "#00C5ff", "#004DA8", "grey"), 
    guide = guide_legend(
      override.aes = list(linetype = "blank",
                          shape = 21, 
                          size = 2))
    ) +
  labs(
    # title = "Driftless Area survey locations", 
    color = "Stream Class", 
    fill = "Survey Site Class"
    ) +
  theme_void() + 
  theme(plot.title = element_text(hjust = 0.5))
```


## 3. Trout presence/abscence

For surveys where no fish where captured but where trout (either species or both) were targeted, specied-sepfic zeros need to be added. 

```{r df-of-zeros, echo=FALSE}

df_trout_0s <-
  bind_rows(
    # all species and game fish targets
    df_fish_raw %>%
      filter(target.species %in% c("all_species","gamefish_species"), 
             species == "no_fish_captured") %>%
      mutate(
        species = "brook_trout",
        number.of.fish = 0,
        ),
    df_fish_raw %>%
      filter(target.species %in% c("all_species","gamefish_species"), 
             species == "no_fish_captured") %>%
      mutate(
        species = "brown_trout",
        number.of.fish = 0, 
        ),
    # brook trout targets
    df_fish_raw %>%
      filter(target.species %in% c("brook_trout"), 
             species == "no_fish_captured") %>%
      mutate(
        species = "brook_trout",
        number.of.fish = 0, 
        ),
    # brown trout targets
    df_fish_raw %>%
      filter(target.species %in% c("brown_trout"), 
             species == "no_fish_captured") %>%
      mutate(
        species = "brown_trout",
        number.of.fish = 0, 
        )
  )

```

```{r update-df}
df_fish <- 
  df_fish_raw %>% 
  filter(!species == "no_fish_captured") %>%
  bind_rows(df_trout_0s) %>%  
  mutate(species = if_else(species == "tiger_trout_(i21_x_i22)", "tiger_trout", species)) %>% 
  filter(species %in% c("brook_trout","brown_trout","tiger_trout"))
```

### count of surveyed wbics in which trout are present:

#### convert catch data to presence data:
```{r convert-to-pa}
df_fish_presence <-
  df_fish %>% 
  group_by(wbic, survey.seq.no, species) %>% 
  summarise(n = sum((number.of.fish)), .groups = "drop") %>% 
  mutate(n = if_else(n > 1, 1, 0))

df_fish_presence_wide <- 
  df_fish_presence %>% 
  pivot_wider(names_from = species, values_from = n, values_fill = 0) %>% 
  mutate(symp = brook_trout + brown_trout) %>% 
  mutate(symp = if_else(symp == 2, 1, 0))

```

#### number wbics with trout present
```{r}
n.wbics.bnt.p <- 
  df_fish_presence_wide %>% 
  select(wbic, brown_trout) %>% 
  filter(brown_trout == 1) %>% 
  pull(wbic) %>% unique() %>% length()

n.wbics.bkt.p <- 
  df_fish_presence_wide %>% 
  select(wbic, brook_trout) %>% 
  filter(brook_trout == 1) %>% 
  pull(wbic) %>% unique() %>% length()

n.wbics.tiger.p <- 
  df_fish_presence_wide %>% 
  select(wbic, tiger_trout) %>% 
  filter(tiger_trout == 1) %>% 
  pull(wbic) %>% unique() %>% length()

n.wbics.symp.p <- 
  df_fish_presence_wide %>% 
  select(wbic, symp) %>% 
  filter(symp == 1) %>% 
  pull(wbic) %>% unique() %>% length()
```

## 4. calculate percentages

#### brown trout 
```{r}
(percent.wbics.bnt.present <- round((n.wbics.bnt.p/n.wbics.classed.surveyed) * 100, digits = 2))
# (percent.wbics.bnt.present12 <- round((n.wbics.bnt.p.12/n.wbics.classed12.surveyed) * 100, digits = 2))
```

#### brook trout
```{r}
(percent.wbics.bkt.present <- round((n.wbics.bkt.p/n.wbics.classed.surveyed) * 100, digits = 2))
# (percent.wbics.bkt.present12 <- round((n.wbics.bkt.p.12/n.wbics.classed12.surveyed) * 100, digits = 2))
```

#### tiger trout
```{r}
(percent.wbics.tgt.present <- round((n.wbics.tiger.p/n.wbics.classed.surveyed) * 100, digits = 2))
# (percent.wbics.tgt.present12 <- round((n.wbics.tiger.p.12/n.wbics.classed12.surveyed) * 100, digits = 2))
```

#### brook/brown sympatry
```{r}
(percent.wbics.symp.present <- round((n.wbics.symp.p/n.wbics.classed.surveyed) * 100, digits = 2))
```


### plot presence/absence

```{r eval=FALSE, fig.align='center', fig.width=10}
panel_labels <- c(
  `brook_trout` = glue("Brook Trout ({percent.wbics.bkt.present}%)"),
  `brown_trout` = glue("Brown Trout ({percent.wbics.bnt.present}%)"),
  `tiger_trout` = glue("Tiger Trout ({percent.wbics.tgt.present}%)")
  )

ggplot() + 
  geom_sf(data = poly_driftless, fill = "white") +
  geom_sf(data = lines_classed_drift, 
          aes(color = TROUT_CLAS), show.legend = "line") +
  # geom_sf(data = df_surveys_drift_locs_classes %>% filter(is.na(TROUT_CLAS)),
  #         size = 1, shape = 16, color = "grey", alpha = 0.25) +
  geom_sf(data = df_fish_presence %>% 
            left_join(df_surveys_drift_classed, by = "survey.seq.no") %>% 
            st_as_sf(), 
          aes(fill = as.factor(n)), show.legend = "point",
          shape = 21, size = 1, alpha = 0.5) + 
  scale_colour_manual(
    values = c("#53DC4D", "#00C5ff", "#004DA8"), 
    guide = guide_legend(
      override.aes = list(linetype = c("solid", "solid","solid"), 
                          shape = c(NA, NA, NA),
                          size = c(1,1,1)))
    ) +
  scale_fill_manual(
    values = c("black", "white"), 
    labels = c("Absent", "Present"),
    guide = guide_legend(
      override.aes = list(linetype = "blank",
                          shape = 21, alpha = 1,
                          size = 2))
    ) +
  facet_wrap(vars(species), labeller = as_labeller(panel_labels)) +
  labs(
    # title = "How common are trout in Driftless Area streams?",
    title ="Percent of all classified and surveyed streams with trout present:",
    # subtitle ="Percent of all classified and surveyed streams with trout present:",
    # caption = "Note: light grey dots depict all surveys sites in the region",
    color = "Stream Class", 
    fill = "Trout Presence") + 
  theme_void() + 
  theme(
    plot.title = element_text(hjust = 0, family = "sans", size = 18, margin=margin(0,0,5,0)), 
    plot.subtitle = element_text(hjust = 0, family = "sans", size = 12, margin=margin(0,0,10,0))
    )

path <- here::here("plots", "driftless_trout_presence")
ggsave(glue::glue("{path}.pdf"), width = 10, height = 5, device = cairo_pdf)
pdftools::pdf_convert(pdf = glue::glue("{path}.pdf"),
            filenames = glue::glue("{path}.png"),
            format = "png", dpi = 300)
  
```


```{r fig.align='center', echo=FALSE, fig.width=10, eval=FALSE}
panel_labels <- c(
  `brook_trout` = glue("Brook Trout ({percent.wbics.bkt.present12}%)"),
  `brown_trout` = glue("Brown Trout ({percent.wbics.bnt.present12}%)"),
  `tiger_trout` = glue("Tiger Trout ({percent.wbics.tgt.present12}%)")
  )

ggplot() + 
  geom_sf(data = poly_driftless, fill = "white") +
  geom_sf(data = lines_classed_drift %>% 
            filter(TROUT_CLAS %in% c("CLASS I", "CLASS II")), 
          aes(color = TROUT_CLAS), show.legend = "line") +
  # geom_sf(data = df_surveys_drift_locs_classes %>% 
  #           filter(TROUT_CLAS %in% c("CLASS I", "CLASS II")),
  #         size = 1, shape = 16, color = "grey", alpha = 0.25) +
  geom_sf(data = df_fish_presence %>% 
            st_as_sf() %>% 
            filter(TROUT_CLAS %in% c("CLASS I", "CLASS II")), 
          aes(fill = as.factor(n)), show.legend = "point",
          shape = 21, size = 1, alpha = 0.5) + 
  scale_colour_manual(
    values = c("#53DC4D", "#00C5ff"), 
    guide = guide_legend(
      override.aes = list(linetype = c("solid", "solid"), 
                          shape = c(NA, NA),
                          size = c(1,1)))
    ) +
  scale_fill_manual(
    values = c("black", "white"), 
    labels = c("Absent", "Present"),
    guide = guide_legend(
      override.aes = list(linetype = "blank",
                          shape = 21, alpha = 1,
                          size = 2))
    ) +
  facet_wrap(vars(species), labeller = as_labeller(panel_labels)) +
  labs(
    # title = "How common are trout in Driftless Area streams?",
    title ="Percent of class I & II surveyed streams with trout present:",
    # subtitle ="Percent of class I & II surveyed streams with trout present:",
    # caption = "Note: light grey dots depict all surveys sites in the region",
    color = "Stream Class", 
    fill = "Trout Presence") + 
  theme_void() + 
  theme(
    plot.title = element_text(hjust = 0.5, family = "sans", size = 18, margin=margin(0,0,5,0)), 
    plot.subtitle = element_text(hjust = 0.5, family = "sans", size = 12, margin=margin(0,0,10,0))
    )

path <- here::here("plots", "driftless_trout_presence_class12")
ggsave(glue::glue("{path}.pdf"), width = 10, height = 5, device = cairo_pdf)
pdftools::pdf_convert(pdf = glue::glue("{path}.pdf"),
            filenames = glue::glue("{path}.png"),
            format = "png", dpi = 300)
  
```
