---
title: "Driftless BNT streams"
author: "Bryan Maitland"
date: "7 July 2021"
output: github_document
---

## Overview

What is the percentage of Driftless ecoregion streams (by WBIC for streams for which we have survey data) in which brown trout are present?

```{r prep, warning=FALSE, message=FALSE}
library(tidyverse)
library(here)
library(rgdal)  
library(sf)
```


## Data

**NOTE:** WI 24k Hydrogrodatabase data is available from [this link](https://data-wi-dnr.opendata.arcgis.com/datasets/wi-dnr::24k-hydro-flowlines-rivers-streams/about). 

```{r read-data, cache=TRUE, warning=FALSE}

trout_data <- 
  here("fmdb_fish_trout.rds") %>% 
  read_rds()

trout_sites_VA <- 
  here("trout-sites-24K-VA.rds") %>% 
  read_rds()


driftless_poly <- 
  here("ecoregions","wi_eco_l3.shp") %>% 
  st_read() %>% 
  st_transform(crs = 3071) %>% 
  filter(US_L3CODE == "52")

hydro_lines <- 
  readOGR(
    dsn = here("24K_Hydro.gdb"), 
    layer = "WD_HYDRO_FLOWLINE_LN_24K") %>% 
  st_as_sf() %>% 
  mutate(hydroid = as.character(HYDROID))

```


```{r prep-data, cache=TRUE}

hydro_lines_driftless <- 
  hydro_lines %>% 
  st_intersection(driftless_poly)

data <- 
  trout_data %>% 
  left_join(trout_sites_VA, by = "site.seq.no") %>% 
  select(county, waterbody.name, wbic, survey.year, survey.seq.no, visit.fish.seq.no, 
         species, number.of.fish, c_eco, hydroid) %>% 
  filter(c_eco == "52") %>% 
  filter(species == "brown_trout")

```

```{r plot data}

ggplot() + 
  geom_sf(data = driftless_poly) + 
  geom_sf(data = hydro_lines_driftless)

```



### get number of wbics

```{r}
# number of distinct wbics
num.of.wbics.24k <- 
  hydro_lines %>% 
  semi_join(data, by = "hydroid") %>% 
  distinct(RIVER_SYS_WBIC) %>% 
  pull() %>% 
  length()

# number of distinct wbics
num.of.wbics.24k <- 
  hydro_lines_driftless %>% 
  distinct(RIVER_SYS_WBIC) %>% 
  pull() %>% 
  length()
```

```{r}
# number of distinct surveys wbics
num.of.wbics <- 
  data %>% 
  distinct(wbic) %>% 
  pull() %>% 
  length()
```


### get number of wbics with BNT

```{r, message=FALSE}
# number of wbics with BNT
num.of.bnt.wbics <-
  data %>% 
  group_by(wbic) %>% 
  summarise(n = sum((number.of.fish))) %>% 
  mutate(n = if_else(n == 0, 0, 1)) %>% 
  filter(n == 1) %>% 
  distinct(wbic) %>% 
  pull() %>% 
  length()
```

### calculate % streams with BNT

```{r, message=FALSE}
(percent.wbics.w.bnt <- round((num.of.bnt.wbics/num.of.wbics) * 100, digits = 2))

(percent.wbics24k.w.bnt <- round((num.of.bnt.wbics/num.of.wbics.24k) * 100, digits = 2) )

```

## Results

In the Driftless Ecoregion of Wisconsin, `r percent.wbics.w.bnt`% of surveyed wbics have Brown Trout present, while `r percent.wbics24k.w.bnt`% of *all* wbics present in the 24k Hydro Geodatabase have Brown Trout present.  

**NOTE:** Result is based on survey data collected from 1994-2020 by Fisheries Management. 